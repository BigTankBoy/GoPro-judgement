{% extends "layout.html" %}

{% block title %}ìˆœìœ„{% endblock %}

{% block head %}
    {{ super() }}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/rank.css') }}">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.1/chart.min.js"></script>
{% endblock %}

{% block content %}
<main>
    <section class="ranking-container">
        <div class="rank-header">
            <h1>ğŸ† ë­í‚¹</h1>
            <div class="view-toggle">
                <button class="toggle-btn active" data-view="table">í…Œì´ë¸”</button>
                <button class="toggle-btn" data-view="chart">ê·¸ë˜í”„</button>
            </div>
        </div>
        
        <div class="view-content">
            <!-- í…Œì´ë¸” ë·° -->
            <div class="table-wrapper view active" id="table-view">
                <table>
                    <thead>
                        <tr>
                            <th>ë­í‚¹</th>
                            <th>ì‚¬ìš©ì</th>
                            <th>ì ìˆ˜</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for user in users %}
                        <tr class="rank-row {% if loop.index == 1 %}first{% elif loop.index == 2 %}second{% elif loop.index == 3 %}third{% endif %}" data-rank="{{ loop.index }}">
                            <td>
                                {% if loop.index == 1 %}
                                    <span class="medal gold">ğŸ¥‡</span>
                                {% elif loop.index == 2 %}
                                    <span class="medal silver">ğŸ¥ˆ</span>
                                {% elif loop.index == 3 %}
                                    <span class="medal bronze">ğŸ¥‰</span>
                                {% else %}
                                    {{ loop.index }}
                                {% endif %}
                            </td>
                            <td>{{ user.username }}</td>
                            <td>{{ user.score }}ì </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <div class="chart-wrapper view" id="chart-view">
                <canvas id="rankingChart"></canvas>
                <div id="custom-tooltip" class="tooltip-content">
                    <div class="tooltip-rank"></div>
                    <div class="tooltip-name"></div>
                    <div class="tooltip-score"></div>
                </div>
            </div>
        </div>
    </section>
</main>

<script>
document.addEventListener('DOMContentLoaded', function() {
    let rankChart = null;
    
    // ì°¨íŠ¸ ì´ˆê¸°í™” ë° ê·¸ë¦¬ê¸°
    function initChart() {
        if (rankChart) {
            rankChart.destroy();
        }
        
        // Jinja í…œí”Œë¦¿ì„ í†µí•´ users ë°ì´í„°ë¥¼ JSON ë¬¸ìì—´ë¡œ ì „ë‹¬í•œ í›„, íŒŒì‹±í•˜ê³  ìˆœìœ„ë¥¼ ì¶”ê°€í•©ë‹ˆë‹¤.
        const users = JSON.parse('{{ users | tojson | safe }}').map((user, index) => ({
            rank: index + 1,
            username: user.username,
            score: user.score
        }));

        const ctx = document.getElementById('rankingChart').getContext('2d');

        // ì°¨íŠ¸ ë°ì´í„° ì¤€ë¹„
        const labels = users.map(user => user.username);
        const scores = users.map(user => user.score);
        const colors = users.map((user, index) => {
            if (index === 0) return 'rgba(255, 215, 0, 0.7)'; // ê¸ˆ
            if (index === 1) return 'rgba(192, 192, 192, 0.7)'; // ì€
            if (index === 2) return 'rgba(205, 127, 50, 0.7)'; // ë™
            return 'rgba(54, 162, 235, 0.5)';
        });

        // ì°¨íŠ¸ ìƒì„±
        rankChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'ì ìˆ˜',
                    data: scores,
                    backgroundColor: colors,
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 3,
                    pointBackgroundColor: colors,
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2,
                    pointRadius: 6,
                    pointHoverRadius: 8,
                    fill: false,
                    tension: 0.1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        enabled: true, // ê¸°ë³¸ Chart.js íˆ´íŒ ì‚¬ìš©
                        callbacks: {
                            title: function(context) {
                                const dataIndex = context[0].dataIndex;
                                return `${users[dataIndex].rank}ìœ„: ${users[dataIndex].username}`;
                            },
                            label: function(context) {
                                return `${context.formattedValue}ì `;
                            }
                        },
                        backgroundColor: 'rgba(255, 255, 255, 0.9)',
                        titleColor: '#333',
                        bodyColor: '#333',
                        borderColor: '#ddd',
                        borderWidth: 1,
                        padding: 10,
                        displayColors: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: false,
                        min: Math.floor(Math.min(...scores) * 0.9),
                        grid: {
                            color: 'rgba(200, 200, 200, 0.2)'
                        }
                    },
                    x: {
                        grid: {
                            display: false
                        }
                    }
                },
                interaction: {
                    mode: 'index',
                    intersect: false
                }
            }
        });
        
        // ì°¨íŠ¸ í´ë¦­ ì´ë²¤íŠ¸ (ì„ íƒì‚¬í•­)
        document.getElementById('rankingChart').onclick = function(evt) {
            const points = rankChart.getElementsAtEventForMode(evt, 'nearest', { intersect: true }, true);
            
            if (points.length) {
                const firstPoint = points[0];
                const dataIndex = firstPoint.index;
                const user = users[dataIndex];
                
                // í´ë¦­ì‹œ ì•¡ì…˜ (í•„ìš”ì‹œ êµ¬í˜„)
                // console.log(`${user.username}: ${user.score}ì  (${user.rank}ìœ„)`);
            }
        };
    }
    
    // ë·° ì „í™˜ ë° ì°¨íŠ¸ ì´ˆê¸°í™” ì½”ë“œ
    const toggleBtns = document.querySelectorAll('.toggle-btn');
    const views = document.querySelectorAll('.view');
    
    toggleBtns.forEach(btn => {
        btn.addEventListener('click', function() {
            const targetView = this.getAttribute('data-view');
            toggleBtns.forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            views.forEach(view => view.classList.remove('active'));
            document.getElementById(`${targetView}-view`).classList.add('active');
            if (targetView === 'chart') {
                initChart();
            }
        });
    });
    
    // ìˆœìœ„ ì• ë‹ˆë©”ì´ì…˜ ì ìš©
    const rankRows = document.querySelectorAll('.rank-row');
    rankRows.forEach((row, index) => {
        row.style.animationDelay = `${index * 0.1}s`;
    });
});
</script>

{% endblock %}